{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/BalancingRobot","result":{"data":{"markdownRemark":{"html":"<p>One of the things I love to do when I find a project that interests me is to try to recreate it myself without viewing their code/cad files etc. Because the purpose of my projects is to learn, I am sure many of the things I post could be done more efficiently. If you have any ideas, I'm always open to suggestions (:</p>\n<p>Below is the current iteration of my robot:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 310px; margin-left:0\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f55fa07d895e13e732c96b6bc5fd9fda/762bd/Niels-Robot.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 133%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAbABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQX/xAAYAQACAwAAAAAAAAAAAAAAAAADBAABAv/aAAwDAQACEAMQAAABRjFBLYTiuue6XXhuEEr/xAAcEAACAgMBAQAAAAAAAAAAAAABAgARAyExEjL/2gAIAQEAAQUCNxkLnEKR+36mJgoL6U45cPR9E7//xAAYEQACAwAAAAAAAAAAAAAAAAAAARARMf/aAAgBAwEBPwF6i5//xAAZEQACAwEAAAAAAAAAAAAAAAAAAgEREhD/2gAIAQIBAT8BS8jpOuUf/8QAHRAAAgIBBQAAAAAAAAAAAAAAAREAEAISITJBgf/aAAgBAQAGPwJuanFMgZyHkLPdbYl0L//EAB4QAAICAgIDAAAAAAAAAAAAAAABESExQVHhYXGB/9oACAEBAAE/IVlKyhNP30S0k8J4PrGMuQZGlmaCems8HSHshFtwvI70Vi2atDFkf//aAAwDAQACAAMAAAAQQOsw/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAEhEUH/2gAIAQMBAT8QdaLhVO00/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAEhERD/2gAIAQIBAT8QdqNDEJycf//EAB0QAQADAAIDAQAAAAAAAAAAAAEAESExQVFxgWH/2gAIAQEAAT8QqMqhoUXfnEOo30uLyr/IoLoD1cbRHAhZXJx7YhD4BGw+S06SUuPstwihRSqhg5lKz43lhWRQ9DxCOAdsiXXA0e48DB52f//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Missing Image\"\n        title=\"Missing Image\"\n        src=\"/static/f55fa07d895e13e732c96b6bc5fd9fda/762bd/Niels-Robot.jpg\"\n        srcset=\"/static/f55fa07d895e13e732c96b6bc5fd9fda/37402/Niels-Robot.jpg 200w,\n/static/f55fa07d895e13e732c96b6bc5fd9fda/762bd/Niels-Robot.jpg 310w\"\n        sizes=\"(max-width: 310px) 100vw, 310px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>The Hardware</h2>\n<p>I started with the obvious hardware, I needed motors, motor drivers, and something to power them. I decided to go with the arduino due as the main microcontroller as it's quite fast, and the SAM chip allows more external interrupts than other arduinos. I also needed an accelerometer/gyro to create a simple feedback loop.</p>\n<p>Heres what I went with:</p>\n<p>2x NEMA 32 2.8A 1.9NM Stepper motors (I went with stronger 1.9NM motors so I could build on the robot later without having to worry about power.)</p>\n<p>2x SainSmart ST-M5045 Stepper Drivers</p>\n<p>1x MPU9050 Accel/gyro</p>\n<p>1x 24v to 12v step down converter</p>\n<h2>The Frame</h2>\n<p>After I had all the electronics, I needed to build a frame for the robot. I went with a large sheet of HDPE that I cut down to size on my table saw, and some cheap threaded rod.</p>\n<p>I cut the threaded rod down to size with a dremel, drilled holes in the HDPE to thread the rod through, and held everything in place with nuts and locking washers. I also drilled a hole to feed the motor wires through, and put in a grommet to protect the wires from fraying and shorting. Then, I simply had to mount all the electronics, and I could begin working on the code.</p>\n<h2>The Code</h2>\n<p>The full current code can be found on my Github page <a href=\"https://github.com/nm47/NMRobot\">here.</a> I'll just give a brief discription of what each of the files does here, there were too many changes and problems and fixes to do a full write up of the process:</p>\n<p><strong>mpu.cpp:</strong></p>\n<p>My first approach was to read the raw data from the accelerometer, and run it through a kalman filter to remove as much noise as posssible. This kind of worked, but was very volitile, and the robot would eventually experience a \"spike\" in values that caused it to accelerate very quickly and fall over. Later I learned that the mpu itself could filter the data via its on-board dmp (digital motion processor). This provided a much smoother output that made the robot a lot more stable. Below you can see the raw output of the accelerometer vs the filtered output of the DMP:</p>\n<p>Raw:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/96e6c720df0713c6913820a5c23b61f8/af8d6/Raw-wave.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe+gWzH/xAAWEAEBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQEAAQUC2qr/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAWEAEBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQEAAT8h2lKf/9oADAMBAAIAAwAAABBDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAIDAQEAAAAAAAAAAAAAAAABEWGhMVH/2gAIAQEAAT8QTXCaJ9LMLMGt9w//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Missing Image\"\n        title=\"Missing Image\"\n        src=\"/static/96e6c720df0713c6913820a5c23b61f8/c60e9/Raw-wave.jpg\"\n        srcset=\"/static/96e6c720df0713c6913820a5c23b61f8/37402/Raw-wave.jpg 200w,\n/static/96e6c720df0713c6913820a5c23b61f8/4cda9/Raw-wave.jpg 400w,\n/static/96e6c720df0713c6913820a5c23b61f8/c60e9/Raw-wave.jpg 800w,\n/static/96e6c720df0713c6913820a5c23b61f8/6c738/Raw-wave.jpg 1200w,\n/static/96e6c720df0713c6913820a5c23b61f8/56dca/Raw-wave.jpg 1600w,\n/static/96e6c720df0713c6913820a5c23b61f8/af8d6/Raw-wave.jpg 1920w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Filtered via DMP:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6eab731aeccf7dbd10a8d6e02333f2f6/af8d6/DMP-wave.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe+gWzH/xAAWEAEBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQEAAQUC2qr/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAWEAEBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQEAAT8h2lKf/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAAIDAQAAAAAAAAAAAAAAAAABMWGhEP/aAAgBAQABPxBR2zCzBrc4f//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Missing Image\"\n        title=\"Missing Image\"\n        src=\"/static/6eab731aeccf7dbd10a8d6e02333f2f6/c60e9/DMP-wave.jpg\"\n        srcset=\"/static/6eab731aeccf7dbd10a8d6e02333f2f6/37402/DMP-wave.jpg 200w,\n/static/6eab731aeccf7dbd10a8d6e02333f2f6/4cda9/DMP-wave.jpg 400w,\n/static/6eab731aeccf7dbd10a8d6e02333f2f6/c60e9/DMP-wave.jpg 800w,\n/static/6eab731aeccf7dbd10a8d6e02333f2f6/6c738/DMP-wave.jpg 1200w,\n/static/6eab731aeccf7dbd10a8d6e02333f2f6/56dca/DMP-wave.jpg 1600w,\n/static/6eab731aeccf7dbd10a8d6e02333f2f6/af8d6/DMP-wave.jpg 1920w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Here I simply read the quaternion values from the dmp, convert to degrees, and put them into a FIFO buffer to be fed into the PID controller.</p>\n<p><strong>NMBot.cpp</strong></p>\n<p>This file handles almost all the calculations done by the robot. It receives values from the mpu, feeds them into the PID controller, and maps them to a speed that can be outputted by the motor. Here is a graph of the PID controller [IMAGE]. red is the setpoint, blue is the pid output, and green is the PID's input directly from the mpu.</p>\n<p>Timers are done differently on the Due than other arduino boards, I used the SAM#X8E's wave generator to trigger an interrupt at the frequency we want. We pass it an IRQ channel and choose the TC handler function that will be called on the interrupt.</p>\n<pre><code class=\"language-javascript\">void NMbot::startTimer(Tc *tc, uint32_t channel, IRQn_Type irq, uint32_t frequency) {\n    pmc_set_writeprotect(false); //allow writing to timer registers\n    pmc_enable_periph_clk((uint32_t)irq); // Enable clock for the timer\n    TC_Configure(tc, channel, TC_CMR_WAVE | TC_CMR_WAVSEL_UP_RC | TC_CMR_TCCLKS_TIMER_CLOCK4); //configure timer in waveform mode\n    uint32_t rc = VARIANT_MCK / 128 / frequency; //128 because we selected TIMER_CLOCK4 above\n    TC_SetRA(tc, channel, rc / 2); //50% high, 50% low\n    TC_SetRC(tc, channel, rc);\n    TC_Start(tc, channel);\n    tc->TC_CHANNEL[channel].TC_IER = TC_IER_CPCS;\n    tc->TC_CHANNEL[channel].TC_IDR = ~TC_IER_CPCS;\n    NVIC_EnableIRQ(irq);\n}\n</code></pre>\n<p><strong>NMRobot.ino</strong></p>\n<p>This is the \"main\" file where everything is set up and called. It's also the file that actually receives the callback from the tc handlers and turns the motors. PullLeft (boolean) flips every time the function is called, and passed into digitalWrite it resolves to an integer:</p>\n<pre><code class=\"language-javascript\">void TC3_Handler(){\n    TC_GetStatus(TC1,0);\n\n    pullLeft = !pullLeft;\n    digitalWrite(PUL_PIN_L, pullLeft);\n}\n</code></pre>\n<h2>Problems</h2>\n<p><strong>Gyroscopic Drift:</strong></p>\n<p>As it turns out, the pitch axis on my gyroscope drifts over time. This happens with all gyroscopes, but the drift was so strong that the robot would eventually drive itself into the ground. I fixed this by switching to the roll axis, which drifts a negligible amount.</p>\n<p><strong>Axle Material:</strong></p>\n<p>The axles were orignally 3D printed in PLA plastic. I knew over time that they would wear down and need to be replaced, so they were printed simply as a placeholder so I could do some testing. Unfortunately, I underestimated the torque the motors could produce, and one of them shattered. I'll fix this in the future by milling some aluminum axles to fit in their place, with grub screws to keep them tight.</p>\n<p><strong>Weight:</strong></p>\n<p>This problem remains unsolved. At the moment the robot can stabilize itself, but only at +- 5 degrees from 90. If it falls higher or lower, the motors cannot accelerate fast enough to keep it stable. There are a few solutions to this: Bigger motors, more power, less weight, and bigger wheels. So far I have lowered the platforms to reduce lower the center of gravity, and I hope to try again with the bigger wheels soon, this should fix the problem.</p>\n<h2>Ongoing</h2>\n<p>This projects is not complete. I am a full time student at the University of Houston, and since school has started up I have not been able to work on this project as much. Hopefully I'll be able to move forward on it sometime during the christmas break. My next step will be to design new mounts for the larger wheels, and see what happens from there.</p>","frontmatter":{"date":"September 06, 2019","path":"/blog/BalancingRobot","title":"Inverted Pendulum Balancing Robot"}}},"pageContext":{}},"staticQueryHashes":[]}