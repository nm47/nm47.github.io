<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.fa1aee69cb3bc7333fa8.css" id="gatsby-global-css">@import url(https://fonts.googleapis.com/css?family=Heebo&display=swap);code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.link-module--wrapper--2dAz0{margin-bottom:30px}.link-module--linkTitle--3VUWq{border-bottom:1px solid #3997dc;color:#32404b;display:inline-block;font-size:20px;font-weight:700;margin-bottom:10px;text-decoration:none}.link-module--linkTitle--3VUWq:hover{color:#3997dc}.link-module--title--3H5Ml{color:#32404b;display:inline-block;font-size:20px;font-weight:700;margin-bottom:10px}.link-module--desc--2JcNe{font-size:16px}.socials-module--list--nQjwE{margin:15px 0 0;padding:0}.socials-module--item--2qCBJ{display:inline-block;list-style:none;margin-right:20px}.socials-module--link--m0nMJ{color:#787a82;text-decoration:none}.socials-module--link--m0nMJ:hover{color:#3997dc}.header-module--headerWrapper--15qHx{display:flex;margin-bottom:90px}.header-module--profileWrapper--17Lox{position:relative}.header-module--profilePicture--1aaYx{border-radius:50%;overflow:hidden;width:185px}.header-module--profileContent--3G8DP{margin:10px 0 0 50px}.header-module--profileContent--3G8DP h1{color:#1f2933;font-size:45px;letter-spacing:2px;margin:0}.header-module--profileContent--3G8DP h2{font-size:20px;font-weight:400;margin:0 0 30px}@media only screen and (max-width:600px){.header-module--profilePicture--1aaYx{width:150px}}@media only screen and (max-width:768px){.header-module--headerWrapper--15qHx{display:block}.header-module--profileWrapper--17Lox{display:block;width:100%}.header-module--profileContent--3G8DP{display:block;margin:25px 0 0;width:100%}}.container-module--wrapper--_zFcw{max-width:1200px;padding:100px;position:relative;width:100%;text-align:left;display:inline-block}@media only screen and (max-width:768px){.container-module--wrapper--_zFcw{padding:50px}}.layout-module--blobMain--3VKey{position:fixed;top:-150px;right:-700px;z-index:-1}.layout-module--blobMain--3VKey svg{width:1300px;height:1300px;opacity:.5}.layout-module--blobSecondary--1ryDs{position:fixed;top:-250px;right:-750px;z-index:-1}.layout-module--blobSecondary--1ryDs svg{width:1500px;opacity:.1;height:1500px}@media only screen and (max-width:1200px){.layout-module--blobMain--3VKey{opacity:.3}.layout-module--blobSecondary--1ryDs{opacity:.5}}@media only screen and (max-width:768px){.layout-module--blobMain--3VKey{display:none}.layout-module--blobSecondary--1ryDs{opacity:.5}}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */h1{font-size:2em}.section-module--wrapper--1PJu9{display:flex;flex-direction:row;margin-bottom:50px}.section-module--left--4Dzzx{width:300px}.section-module--right--3Zh5J{flex:1 1;max-width:700px}.section-module--title--3LB2K{color:#787a82;font-size:14px;font-weight:400;margin:0 0 30px;letter-spacing:3px;text-transform:uppercase}@media only screen and (max-width:768px){.section-module--wrapper--1PJu9{display:block}.section-module--left--4Dzzx,.section-module--right--3Zh5J{display:block;width:100%}}.blogpost-module--blobMain--1DUNn{position:fixed;top:-150px;right:-700px;z-index:-1}.blogpost-module--blobMain--1DUNn svg{width:1300px;height:1300px;opacity:.2}@media only screen and (max-width:1200px){.blogpost-module--blobMain--1DUNn{display:none}}@media only screen and (max-width:768px){.blogpost-module--blobMain--1DUNn{display:none}}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15}body{margin:0}main{display:block}h1{font-size:2.5em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*,:after,:before{box-sizing:inherit}html{background:#fff;color:#52606d;font-size:15px;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box}body{font-family:Heebo,sans-serif;font-size:1em;line-height:1.25;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}img{max-width:100%;margin:0}p{color:#3b3942;font-size:18px;line-height:1.5;margin:0 0 30px}.hr{box-sizing:content-box;width:25%;border:1px solid #e2e8f0;margin:0}</style><meta name="generator" content="Gatsby 2.27.0"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><title data-react-helmet="true"></title><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link as="script" rel="preload" href="/webpack-runtime-639daae00ea834df6c5d.js"/><link as="script" rel="preload" href="/framework-8e528b732ab2eaadb7b7.js"/><link as="script" rel="preload" href="/app-27606a25c4ba33841913.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-2c036092b92d9d670eba.js"/><link as="fetch" rel="preload" href="/page-data/blog/cube/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="container-module--wrapper--_zFcw"><h1 class="mt-16 text-4xl text-gray-900 font-bold">Reaction Wheel Cube</h1><p class="text-gray-600 font-light">Posted on <!-- -->May 02, 2019</p><div class="blog-post-content"><p><strong>Update: Part 2 can be found Here:</strong><br>
<strong><a href="/blog/CubeCAD">Part 2: CAD and Machining</a></strong></p>
<p>I thought since I'm now locked down because of the coronavirus that I would start a new project. I was quite fascinated with the <a href="https://idsc.ethz.ch/research-dandrea/research-projects/archive/cubli.html">cubli</a>, it's amazing how well tuned it is, but the part that impressed me the most was how quickly it rejected disturbances and re-stabilized. Over the last few weeks I've gotten started, and I've gotten a good amount done, but this will be done in parts as it will be quite a long project.</p>
<h2>The Motor</h2>
<p>I thought I would start with the motor, since without that I couldn't really design much of anything outside of the Accelerometer/Gyro. This would probably be significantly easier with brushed motors, but I want to avoid that for a couple of reasons. First, the kind of brushed motors that I would need are very expensive because of the rare earth magnets used in them, and secondly, I think it would be cool to try building my own encoder for a brushless motor. </p>
<h2>The Encoder</h2>
<p>This is the first big hurdle in the project. Most (cheap) commercial ESC's use back EMF to determine the position of a brushless motor. That won't work here because I'm going to need to be able to drive the motor at slow speeds (you can't easily do this with backEMF because the slower a brushless motor goes the more current it takes to drive, making it very hard to detect the back EMF). I also need to reverse, which is a problem with back EMF because you obviously have to go slow before you reverse. For these reasons I went with Hall Sensors. They should detect the position of the rotor regardless of its speed, position, or direction, but they will be quite a bit harder to set up.</p>
<h2>Design iterations</h2>
<p>I created many different Hall boards before I settled on a final design, below are a few iterations:</p>
<p><strong>Hallboard 1:</strong><br>
hand drilled pcb meant that hall sensor position was not accurate. They were not easy to space 60 degrees apart, and were not equidistant from the motor. Hand positioning with an oscilloscope was tedius and results were still not very reliable. Used A3144 through hole hall sensors, which were not as sensitive as I was hoping.</p>
<p><strong>Hallboard 2:</strong><br>
Significantly better than hallboard one, professionally fabricated PCB fixed the hole placement issue. Switching to new, more sensitive hall sensors (A1302) made results more reliable, however their placement along the outside of the motor meant that the magnetic field was still too weak to get reliable readings. The quiescent voltage of the sensors was 2.5V, and I observed readings from 2.1-2.65 volts depending on magnet polarity. I used external comparators to create a digital signal for the arduino, but I was worried that motor steps would be skipped because hall sensors would not detect the field.</p>
<p><strong>Hallboard 3:</strong><br>
Far better than the other two. I switched to SMD hall sensors after the position had been fine tuned, which made placement almost impossible to screw up. The Hall sensors were moved to the poles of the magnets where the field is stronger, as opposed to the outside of the motor. I switched to the newer A1304 sensors which seem to be much more sensitive as well, the quiescent voltage is 1.65v, and I observe a range from 0.1 volts to 3.2 volts, a much more comfortable range. I removed the comparators with the intention of using the Teensy's internal comparator (with the quiescent voltage on the AREF pin), however it works so well as is that I don't think that's necessary.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/2c99f5a22b24d567f95303d7b07548e4/e1e54/encoder_combined.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBP/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB2Qalwf/EABgQAQEAAwAAAAAAAAAAAAAAAAECABEh/9oACAEBAAEFAg7MrJOs/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGRAAAwADAAAAAAAAAAAAAAAAAAERAiEx/9oACAEBAAY/ArTeTrOs/8QAGxABAAICAwAAAAAAAAAAAAAAAQARITGBocH/2gAIAQEAAT8hUSa9TQGZTyUqOduf/9oADAMBAAIAAwAAABAL/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAACAwEBAAAAAAAAAAAAAAABEQAhQYFx/9oACAEBAAE/ELs+QNByHBKAYQHjI6Tt4umf/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="encoder image not found"
        title="encoder image not found"
        src="/static/2c99f5a22b24d567f95303d7b07548e4/9d361/encoder_combined.jpg"
        srcset="/static/2c99f5a22b24d567f95303d7b07548e4/8f721/encoder_combined.jpg 200w,
/static/2c99f5a22b24d567f95303d7b07548e4/81a96/encoder_combined.jpg 400w,
/static/2c99f5a22b24d567f95303d7b07548e4/9d361/encoder_combined.jpg 800w,
/static/2c99f5a22b24d567f95303d7b07548e4/e1e54/encoder_combined.jpg 870w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span>  </p>
<h2>Testing on the oscilloscope</h2>
<p>Before I ran the motor, I used a different motor to spin it up, with the oscilloscope connected to two of its phases. By using a different motor to spin the first, you can view nothing but the back EMF, which is much easier than just using one motor.</p>
<p>Here is an example of the output of middle hall sensor (hall sensor on bottom, EMF on top). The middle one should be inverted in a 12N14P motor, meaning low back EMF should correspond to high on the sensor.</p>
<p>Heres a picture of what that looks like:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 443px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/10fb31d0e5c575ead21eaeef70b1a3d5/2f101/oscilloscope-encoder.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 76.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIDBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAADBP/aAAwDAQACEAMQAAABy3WS2emALf/EABsQAAICAwEAAAAAAAAAAAAAAAECABMDEiEx/9oACAEBAAEFAlx7SmFeowAth9//xAAYEQACAwAAAAAAAAAAAAAAAAAAIQIRE//aAAgBAwEBPwGWloZ//8QAGBEAAgMAAAAAAAAAAAAAAAAAABIBAhH/2gAIAQIBAT8BqmEof//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAQEAAgMAAAAAAAAAAAAAAAEAESExYYH/2gAIAQEAAT8hIcl4sCJ1die+L//aAAwDAQACAAMAAAAQQ8//xAAYEQACAwAAAAAAAAAAAAAAAAAAAREhQf/aAAgBAwEBPxCJ8Cof/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARMf/aAAgBAgEBPxALmGm//8QAHBABAAICAwEAAAAAAAAAAAAAAREhAFExQWGR/9oACAEBAAE/EECDDc63i4YZ691jVlMVkoirSbOzCbbuZ74n5g8hJrP/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="oscilloscope image not found"
        title="oscilloscope image not found"
        src="/static/10fb31d0e5c575ead21eaeef70b1a3d5/2f101/oscilloscope-encoder.jpg"
        srcset="/static/10fb31d0e5c575ead21eaeef70b1a3d5/8f721/oscilloscope-encoder.jpg 200w,
/static/10fb31d0e5c575ead21eaeef70b1a3d5/81a96/oscilloscope-encoder.jpg 400w,
/static/10fb31d0e5c575ead21eaeef70b1a3d5/2f101/oscilloscope-encoder.jpg 443w"
        sizes="(max-width: 443px) 100vw, 443px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>After that, I used the following code just to verify that it was all working nicely, this is the output as I rotate the motor by hand.</p>
<div class="gatsby-highlight" data-language="cpp"><pre style="counter-reset: linenumber NaN" class="language-cpp line-numbers"><code class="language-cpp"><span class="token comment">// If 1, states will be output numerically, ie. 3 instead of 011</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression">NUMERICAL_STATES <span class="token number">0</span></span></span>

<span class="token comment">//define hall Sensor pins</span>
<span class="token keyword">const</span> <span class="token keyword">short</span> HA <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">short</span> HB <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">short</span> HC <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token keyword">short</span> state <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The A1304 output pin must be pulled up to 3.3v</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>HA<span class="token punctuation">,</span> INPUT_PULLUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>HB<span class="token punctuation">,</span> INPUT_PULLUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>HC<span class="token punctuation">,</span> INPUT_PULLUP<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// turn on the on-board LED to indicate logging has started.</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get the current state of the hall sensors.</span>
<span class="token comment">// if the state has changed we must commutate windings.</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> new_state <span class="token operator">=</span> <span class="token function">GetHallState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> new_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NUMERICAL_STATES<span class="token punctuation">)</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>new_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> new_state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Returns the current position of the rotor.</span>
<span class="token comment">// -1 should not be possible, if hall sensors don't match the 6 steps E-Stop.</span>
<span class="token keyword">short</span> <span class="token function">GetHallState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> hallA <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>HA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> hallB <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>HB<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> hallC <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>HC<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NUMERICAL_STATES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>hallA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>hallB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hallC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Converts hall sensor readings to numerical states</span>
  <span class="token comment">// 101 001 011 010 110 100</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hallA <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hallB <span class="token operator">&amp;&amp;</span> hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hallA <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hallB <span class="token operator">&amp;&amp;</span> hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hallA <span class="token operator">&amp;&amp;</span> hallB <span class="token operator">&amp;&amp;</span> hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hallA <span class="token operator">&amp;&amp;</span> hallB <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hallA <span class="token operator">&amp;&amp;</span> hallB <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hallA <span class="token operator">&amp;&amp;</span>  <span class="token operator">!</span>hallB <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hallC<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">6</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// This should never happen, if it somehow does, states of the hall sensors are</span>
    <span class="token comment">// printed at the time of failure for debugging purposes. This also calls</span>
    <span class="token comment">// the emergency stop in the full program.</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>hallA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>hallB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hallC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>This was harder than I expected to set up, so I figured I'd go through the problems I had in case anyone is doing something similar.</p>
<ol>
<li>I started this by milling PCBs on a CNC machine, but using through hole components meant that I couldn't exactly align the hall sensors every time. This offset caused my controller to switch magnets at (slightly) incorrect times, leading to a huge increase in heat as well as increased current draw. This was fixed by using SMD components. Applying solder paste and reflowing all the components onto the board made a huge difference in heat and current draw.</li>
<li>My power supply was insufficient. I have a 30V 5A max variable power supply that I was testing on, however I noticed the power to the microcontroller was dipping significantly when the motor was running slower. This led to the microcontroller browning out and outputting insufficient voltage to the gates, only partially opening the MOSFETS and causing one to heat up very quickly and explode. This was fixed by testing on a LIPO battery, which has much higher burst currents and allows me to slow the motor much more without excess heat.</li>
<li>To test, I simply de-soldered the Atmega8a chip on the ESC and soldered my own wires to the pins that controlled the MOSFETS (more on this later). This allowed me to control the motor without building my own ESC, but it is not very clean. I may attempt to build my own ESC for this later on. The advantage of this however is that if it does not work, you know that the problem is with your setup, and not the ESC itself.</li>
</ol>
<h2>The ESC</h2>
<p>As I said earlier, I used a multimeter to determine which pins of the Atmega8a were controlling the MOSFETS, and soldered my own wires to them to control the ESC externally. This is what that setup looks like:</p>
<p>This was my first attempt soldering on something this small, the wire was too long and I had a hard time getting a clean joint, so you can see scorch marks on the board.
Here's the fully wired up ESC:  </p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/3ab6208aae1c171107cce427b78581d6/c4542/esc-closeup-combined.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 37.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAME/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAHKJ0uD/8QAGhAAAQUBAAAAAAAAAAAAAAAAAQACERITIf/aAAgBAQABBQKBThdqv//EABURAQEAAAAAAAAAAAAAAAAAAAIQ/9oACAEDAQE/AVP/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAEBAAMAAAAAAAAAAAAAAAABABEhMf/aAAgBAQAGPwI3OUujf//EABoQAAICAwAAAAAAAAAAAAAAAAABESFBUWH/2gAIAQEAAT8hUlAxImrFp0Nn/9oADAMBAAIAAwAAABCML//EABcRAQEBAQAAAAAAAAAAAAAAAAEAESH/2gAIAQMBAT8Q4DJL/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAEx/9oACAECAQE/ENSP/8QAGhABAQACAwAAAAAAAAAAAAAAAREAITFBUf/aAAgBAQABPxDVIDFE97ymQQUANdZAqryC3j3P/9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Missing Image"
        title="Missing Image"
        src="/static/3ab6208aae1c171107cce427b78581d6/9d361/esc-closeup-combined.jpg"
        srcset="/static/3ab6208aae1c171107cce427b78581d6/8f721/esc-closeup-combined.jpg 200w,
/static/3ab6208aae1c171107cce427b78581d6/81a96/esc-closeup-combined.jpg 400w,
/static/3ab6208aae1c171107cce427b78581d6/9d361/esc-closeup-combined.jpg 800w,
/static/3ab6208aae1c171107cce427b78581d6/c4542/esc-closeup-combined.jpg 944w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>The ESC also has an UBEC which I am using to power the arduino, however I am going to change this because I don't want the same thing to happen to the MOSFETs if the power through the UBEC drops again. </p>
<h2>State of the project</h2>
<p>Currently, I am able to control the speed of the motor. I can make it go slow, fast, and in reverse. This is a significant part of the project so hopefully I'll be able to get working on some code soon.</p>
<p>For now, this is the roadmap for the project:</p>
<h3>Future</h3>
<ul>
<li>Machine the Flywheel, Faceplate and Mounts</li>
<li>Simulate the Initial "pop-up" of the Cube</li>
<li>Add Accelerometers/Gyroscopes</li>
<li>Software, PID/Kalman Filter</li>
</ul>
<h3>Completed</h3>
<ul>
<li>Design and Fab Hall Sensor Board</li>
<li>Control the ESC from the Teensy 3.5</li>
</ul>
<p>With the Motor and Encoder working, it's time to design the body of the cube<br>
<a href="/blog/CubeCAD">Part 2: CAD and Machining</a></p></div><hr class="hr"/></div><div class="blogpost-module--blobMain--1DUNn"><svg width="504" height="784" fill="none" viewBox="0 0 604 784"><defs><pattern id="5d0dd344-b041-4d26-bec4-8d33ea57ec9b" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="4" height="4" class="text-gray-200" fill="#3586ea"></rect></pattern></defs><rect width="404" height="784" fill="url(#5d0dd344-b041-4d26-bec4-8d33ea57ec9b)"></rect></svg></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HE902F5X68"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-HE902F5X68', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/cube";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-78cdc6a84a6e659c51c0.js"],"app":["/app-27606a25c4ba33841913.js"],"component---src-pages-404-js":["/component---src-pages-404-js-3ec2719c0f7642817306.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b5481b2bbe97fe664841.js"],"component---src-pages-page-2-js":["/component---src-pages-page-2-js-c22f2e46250c07e3cc13.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-2c036092b92d9d670eba.js"]};/*]]>*/</script><script src="/polyfill-78cdc6a84a6e659c51c0.js" nomodule=""></script><script src="/component---src-templates-blog-template-js-2c036092b92d9d670eba.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-27606a25c4ba33841913.js" async=""></script><script src="/framework-8e528b732ab2eaadb7b7.js" async=""></script><script src="/webpack-runtime-639daae00ea834df6c5d.js" async=""></script></body></html>