<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.fa1aee69cb3bc7333fa8.css" id="gatsby-global-css">@import url(https://fonts.googleapis.com/css?family=Heebo&display=swap);code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.link-module--wrapper--2dAz0{margin-bottom:30px}.link-module--linkTitle--3VUWq{border-bottom:1px solid #3997dc;color:#32404b;display:inline-block;font-size:20px;font-weight:700;margin-bottom:10px;text-decoration:none}.link-module--linkTitle--3VUWq:hover{color:#3997dc}.link-module--title--3H5Ml{color:#32404b;display:inline-block;font-size:20px;font-weight:700;margin-bottom:10px}.link-module--desc--2JcNe{font-size:16px}.socials-module--list--nQjwE{margin:15px 0 0;padding:0}.socials-module--item--2qCBJ{display:inline-block;list-style:none;margin-right:20px}.socials-module--link--m0nMJ{color:#787a82;text-decoration:none}.socials-module--link--m0nMJ:hover{color:#3997dc}.header-module--headerWrapper--15qHx{display:flex;margin-bottom:90px}.header-module--profileWrapper--17Lox{position:relative}.header-module--profilePicture--1aaYx{border-radius:50%;overflow:hidden;width:185px}.header-module--profileContent--3G8DP{margin:10px 0 0 50px}.header-module--profileContent--3G8DP h1{color:#1f2933;font-size:45px;letter-spacing:2px;margin:0}.header-module--profileContent--3G8DP h2{font-size:20px;font-weight:400;margin:0 0 30px}@media only screen and (max-width:600px){.header-module--profilePicture--1aaYx{width:150px}}@media only screen and (max-width:768px){.header-module--headerWrapper--15qHx{display:block}.header-module--profileWrapper--17Lox{display:block;width:100%}.header-module--profileContent--3G8DP{display:block;margin:25px 0 0;width:100%}}.container-module--wrapper--_zFcw{max-width:1200px;padding:100px;position:relative;width:100%;text-align:left;display:inline-block}@media only screen and (max-width:768px){.container-module--wrapper--_zFcw{padding:50px}}.layout-module--blobMain--3VKey{position:fixed;top:-150px;right:-700px;z-index:-1}.layout-module--blobMain--3VKey svg{width:1300px;height:1300px;opacity:.5}.layout-module--blobSecondary--1ryDs{position:fixed;top:-250px;right:-750px;z-index:-1}.layout-module--blobSecondary--1ryDs svg{width:1500px;opacity:.1;height:1500px}@media only screen and (max-width:1200px){.layout-module--blobMain--3VKey{opacity:.3}.layout-module--blobSecondary--1ryDs{opacity:.5}}@media only screen and (max-width:768px){.layout-module--blobMain--3VKey{display:none}.layout-module--blobSecondary--1ryDs{opacity:.5}}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */h1{font-size:2em}.section-module--wrapper--1PJu9{display:flex;flex-direction:row;margin-bottom:50px}.section-module--left--4Dzzx{width:300px}.section-module--right--3Zh5J{flex:1 1;max-width:700px}.section-module--title--3LB2K{color:#787a82;font-size:14px;font-weight:400;margin:0 0 30px;letter-spacing:3px;text-transform:uppercase}@media only screen and (max-width:768px){.section-module--wrapper--1PJu9{display:block}.section-module--left--4Dzzx,.section-module--right--3Zh5J{display:block;width:100%}}.blogpost-module--blobMain--1DUNn{position:fixed;top:-150px;right:-700px;z-index:-1}.blogpost-module--blobMain--1DUNn svg{width:1300px;height:1300px;opacity:.2}@media only screen and (max-width:1200px){.blogpost-module--blobMain--1DUNn{display:none}}@media only screen and (max-width:768px){.blogpost-module--blobMain--1DUNn{display:none}}

/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15}body{margin:0}main{display:block}h1{font-size:2.5em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}*,:after,:before{box-sizing:inherit}html{background:#fff;color:#52606d;font-size:15px;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box}body{font-family:Heebo,sans-serif;font-size:1em;line-height:1.25;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}img{max-width:100%;margin:0}p{color:#3b3942;font-size:18px;line-height:1.5;margin:0 0 30px}.hr{box-sizing:content-box;width:25%;border:1px solid #e2e8f0;margin:0}</style><meta name="generator" content="Gatsby 2.27.0"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><title data-react-helmet="true"></title><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link as="script" rel="preload" href="/webpack-runtime-639daae00ea834df6c5d.js"/><link as="script" rel="preload" href="/framework-8e528b732ab2eaadb7b7.js"/><link as="script" rel="preload" href="/app-27606a25c4ba33841913.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-2c036092b92d9d670eba.js"/><link as="fetch" rel="preload" href="/page-data/blog/BalancingRobot/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="container-module--wrapper--_zFcw"><h1 class="mt-16 text-4xl text-gray-900 font-bold">Inverted Pendulum Balancing Robot</h1><p class="text-gray-600 font-light">Posted on <!-- -->September 06, 2019</p><div class="blog-post-content"><p>One of the things I love to do when I find a project that interests me is to try to recreate it myself without viewing their code/cad files etc. Because the purpose of my projects is to learn, I am sure many of the things I post could be done more efficiently. If you have any ideas, I'm always open to suggestions (:</p>
<p>Below is the current iteration of my robot:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 310px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f55fa07d895e13e732c96b6bc5fd9fda/84062/Niels-Robot.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 133%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAbABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABgBAAIDAAAAAAAAAAAAAAAAAAMEAAEC/9oADAMBAAIQAxAAAAHOpIJdjOW1z7Zjo7IJX//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMRITIS/9oACAEBAAEFAtxkLmoYR5n1KmCgvpTXMw9Donf/xAAYEQACAwAAAAAAAAAAAAAAAAAAARARMf/aAAgBAwEBPwF6i5//xAAZEQACAwEAAAAAAAAAAAAAAAAAAgEREhD/2gAIAQIBAT8BS8jpOuUf/8QAHhAAAgEDBQAAAAAAAAAAAAAAAAERAhASICEyQYH/2gAIAQEABj8CykyIGjkvBy+7bUudP//EAB4QAQACAgIDAQAAAAAAAAAAAAEAESExQeFRYXGB/9oACAEBAAE/IWwLICx+9S2kvwOp+sZS3lMMm8INcx1OlHbANLR7jniEBRucXEQj/9oADAMBAAIAAwAAABAAyTz/xAAZEQACAwEAAAAAAAAAAAAAAAAAIQERQVH/2gAIAQMBAT8QnFnBmayz/8QAGREAAgMBAAAAAAAAAAAAAAAAAAEQESFh/9oACAECAQE/EGbgsME8pQ//xAAdEAEAAgIDAQEAAAAAAAAAAAABABEhMUFRgXGh/9oACAEBAAE/EKKKhFCi58S+ne0uF4/IoLgC+rxEXQtwhZWzX1iQPQI2HktWqSlr2W4IoUAqoYOMtI8Z2wrIoeB1KlDliJcuA0fdx4Dg7Ln/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Missing Image"
        title="Missing Image"
        src="/static/f55fa07d895e13e732c96b6bc5fd9fda/84062/Niels-Robot.jpg"
        srcset="/static/f55fa07d895e13e732c96b6bc5fd9fda/8f721/Niels-Robot.jpg 200w,
/static/f55fa07d895e13e732c96b6bc5fd9fda/84062/Niels-Robot.jpg 310w"
        sizes="(max-width: 310px) 100vw, 310px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<h2>The Hardware</h2>
<p>I started with the obvious hardware, I needed motors, motor drivers, and something to power them. I decided to go with the arduino due as the main microcontroller as it's quite fast, and the SAM chip allows more external interrupts than other arduinos. I also needed an accelerometer/gyro to create a simple feedback loop.</p>
<p>Heres what I went with:</p>
<p>2x NEMA 32 2.8A 1.9NM Stepper motors (I went with stronger 1.9NM motors so I could build on the robot later without having to worry about power.)</p>
<p>2x SainSmart ST-M5045 Stepper Drivers</p>
<p>1x MPU9050 Accel/gyro</p>
<p>1x 24v to 12v step down converter</p>
<h2>The Frame</h2>
<p>After I had all the electronics, I needed to build a frame for the robot. I went with a large sheet of HDPE that I cut down to size on my table saw, and some cheap threaded rod.</p>
<p>I cut the threaded rod down to size with a dremel, drilled holes in the HDPE to thread the rod through, and held everything in place with nuts and locking washers. I also drilled a hole to feed the motor wires through, and put in a grommet to protect the wires from fraying and shorting. Then, I simply had to mount all the electronics, and I could begin working on the code.</p>
<h2>The Code</h2>
<p>The full current code can be found on my Github page <a href="https://github.com/nm47/NMRobot">here.</a> I'll just give a brief discription of what each of the files does here, there were too many changes and problems and fixes to do a full write up of the process:</p>
<p><strong>mpu.cpp:</strong></p>
<p>My first approach was to read the raw data from the accelerometer, and run it through a kalman filter to remove as much noise as posssible. This kind of worked, but was very volitile, and the robot would eventually experience a "spike" in values that caused it to accelerate very quickly and fall over. Later I learned that the mpu itself could filter the data via its on-board dmp (digital motion processor). This provided a much smoother output that made the robot a lot more stable. Below you can see the raw output of the accelerometer vs the filtered output of the DMP:</p>
<p>Raw:
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/96e6c720df0713c6913820a5c23b61f8/5cdd9/Raw-wave.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB30hVEf/EABcQAQEBAQAAAAAAAAAAAAAAAAARARD/2gAIAQEAAQUC7VXX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGBAAAwEBAAAAAAAAAAAAAAAAABFRARD/2gAIAQEAAT8h6w9Nsf/aAAwDAQACAAMAAAAQc8//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAACAgMBAAAAAAAAAAAAAAAAAREhMVGh8P/aAAgBAQABPxBNEvROyvPDyQk64R//2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Missing Image"
        title="Missing Image"
        src="/static/96e6c720df0713c6913820a5c23b61f8/9d361/Raw-wave.jpg"
        srcset="/static/96e6c720df0713c6913820a5c23b61f8/8f721/Raw-wave.jpg 200w,
/static/96e6c720df0713c6913820a5c23b61f8/81a96/Raw-wave.jpg 400w,
/static/96e6c720df0713c6913820a5c23b61f8/9d361/Raw-wave.jpg 800w,
/static/96e6c720df0713c6913820a5c23b61f8/ca9b4/Raw-wave.jpg 1200w,
/static/96e6c720df0713c6913820a5c23b61f8/9d9f1/Raw-wave.jpg 1600w,
/static/96e6c720df0713c6913820a5c23b61f8/5cdd9/Raw-wave.jpg 1920w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>Filtered via DMP:
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; margin-left:0"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6eab731aeccf7dbd10a8d6e02333f2f6/5cdd9/DMP-wave.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 56.49999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB30hVEf/EABcQAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQEAAQUC2lZWf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAABRARARYf/aAAgBAQABPyG9s7EuP//aAAwDAQACAAMAAAAQ88//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAgMBAAAAAAAAAAAAAAABAPAQITGh/9oACAEBAAE/EDmaiUEE68E//9k='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Missing Image"
        title="Missing Image"
        src="/static/6eab731aeccf7dbd10a8d6e02333f2f6/9d361/DMP-wave.jpg"
        srcset="/static/6eab731aeccf7dbd10a8d6e02333f2f6/8f721/DMP-wave.jpg 200w,
/static/6eab731aeccf7dbd10a8d6e02333f2f6/81a96/DMP-wave.jpg 400w,
/static/6eab731aeccf7dbd10a8d6e02333f2f6/9d361/DMP-wave.jpg 800w,
/static/6eab731aeccf7dbd10a8d6e02333f2f6/ca9b4/DMP-wave.jpg 1200w,
/static/6eab731aeccf7dbd10a8d6e02333f2f6/9d9f1/DMP-wave.jpg 1600w,
/static/6eab731aeccf7dbd10a8d6e02333f2f6/5cdd9/DMP-wave.jpg 1920w"
        sizes="(max-width: 800px) 100vw, 800px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>Here I simply read the quaternion values from the dmp, convert to degrees, and put them into a FIFO buffer to be fed into the PID controller.</p>
<p><strong>NMBot.cpp</strong></p>
<p>This file handles almost all the calculations done by the robot. It receives values from the mpu, feeds them into the PID controller, and maps them to a speed that can be outputted by the motor. Here is a graph of the PID controller [IMAGE]. red is the setpoint, blue is the pid output, and green is the PID's input directly from the mpu.</p>
<p>Timers are done differently on the Due than other arduino boards, I used the SAM#X8E's wave generator to trigger an interrupt at the frequency we want. We pass it an IRQ channel and choose the TC handler function that will be called on the interrupt.</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">void</span> NMbot<span class="token operator">:</span><span class="token operator">:</span><span class="token function">startTimer</span><span class="token punctuation">(</span><span class="token parameter">Tc <span class="token operator">*</span>tc<span class="token punctuation">,</span> uint32_t channel<span class="token punctuation">,</span> IRQn_Type irq<span class="token punctuation">,</span> uint32_t frequency</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pmc_set_writeprotect</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//allow writing to timer registers</span>
    <span class="token function">pmc_enable_periph_clk</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Enable clock for the timer</span>
    <span class="token function">TC_Configure</span><span class="token punctuation">(</span>tc<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> <span class="token constant">TC_CMR_WAVE</span> <span class="token operator">|</span> <span class="token constant">TC_CMR_WAVSEL_UP_RC</span> <span class="token operator">|</span> <span class="token constant">TC_CMR_TCCLKS_TIMER_CLOCK4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//configure timer in waveform mode</span>
    uint32_t rc <span class="token operator">=</span> <span class="token constant">VARIANT_MCK</span> <span class="token operator">/</span> <span class="token number">128</span> <span class="token operator">/</span> frequency<span class="token punctuation">;</span> <span class="token comment">//128 because we selected TIMER_CLOCK4 above</span>
    <span class="token function">TC_SetRA</span><span class="token punctuation">(</span>tc<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> rc <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//50% high, 50% low</span>
    <span class="token function">TC_SetRC</span><span class="token punctuation">(</span>tc<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TC_Start</span><span class="token punctuation">(</span>tc<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tc<span class="token operator">-</span><span class="token operator">></span><span class="token constant">TC_CHANNEL</span><span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token constant">TC_IER</span> <span class="token operator">=</span> <span class="token constant">TC_IER_CPCS</span><span class="token punctuation">;</span>
    tc<span class="token operator">-</span><span class="token operator">></span><span class="token constant">TC_CHANNEL</span><span class="token punctuation">[</span>channel<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token constant">TC_IDR</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">TC_IER_CPCS</span><span class="token punctuation">;</span>
    <span class="token function">NVIC_EnableIRQ</span><span class="token punctuation">(</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><strong>NMRobot.ino</strong></p>
<p>This is the "main" file where everything is set up and called. It's also the file that actually receives the callback from the tc handlers and turns the motors. PullLeft (boolean) flips every time the function is called, and passed into digitalWrite it resolves to an integer:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">void</span> <span class="token function">TC3_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">TC_GetStatus</span><span class="token punctuation">(</span><span class="token constant">TC1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pullLeft <span class="token operator">=</span> <span class="token operator">!</span>pullLeft<span class="token punctuation">;</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span><span class="token constant">PUL_PIN_L</span><span class="token punctuation">,</span> pullLeft<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Problems</h2>
<p><strong>Gyroscopic Drift:</strong></p>
<p>As it turns out, the pitch axis on my gyroscope drifts over time. This happens with all gyroscopes, but the drift was so strong that the robot would eventually drive itself into the ground. I fixed this by switching to the roll axis, which drifts a negligible amount.</p>
<p><strong>Axle Material:</strong></p>
<p>The axles were orignally 3D printed in PLA plastic. I knew over time that they would wear down and need to be replaced, so they were printed simply as a placeholder so I could do some testing. Unfortunately, I underestimated the torque the motors could produce, and one of them shattered. I'll fix this in the future by milling some aluminum axles to fit in their place, with grub screws to keep them tight.</p>
<p><strong>Weight:</strong></p>
<p>This problem remains unsolved. At the moment the robot can stabilize itself, but only at +- 5 degrees from 90. If it falls higher or lower, the motors cannot accelerate fast enough to keep it stable. There are a few solutions to this: Bigger motors, more power, less weight, and bigger wheels. So far I have lowered the platforms to reduce lower the center of gravity, and I hope to try again with the bigger wheels soon, this should fix the problem.</p>
<h2>Ongoing</h2>
<p>This projects is not complete. I am a full time student at the University of Houston, and since school has started up I have not been able to work on this project as much. Hopefully I'll be able to move forward on it sometime during the christmas break. My next step will be to design new mounts for the larger wheels, and see what happens from there.</p></div><hr class="hr"/></div><div class="blogpost-module--blobMain--1DUNn"><svg width="504" height="784" fill="none" viewBox="0 0 604 784"><defs><pattern id="5d0dd344-b041-4d26-bec4-8d33ea57ec9b" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="4" height="4" class="text-gray-200" fill="#3586ea"></rect></pattern></defs><rect width="404" height="784" fill="url(#5d0dd344-b041-4d26-bec4-8d33ea57ec9b)"></rect></svg></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-HE902F5X68"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-HE902F5X68', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/BalancingRobot";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-78cdc6a84a6e659c51c0.js"],"app":["/app-27606a25c4ba33841913.js"],"component---src-pages-404-js":["/component---src-pages-404-js-3ec2719c0f7642817306.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b5481b2bbe97fe664841.js"],"component---src-pages-page-2-js":["/component---src-pages-page-2-js-c22f2e46250c07e3cc13.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-2c036092b92d9d670eba.js"]};/*]]>*/</script><script src="/polyfill-78cdc6a84a6e659c51c0.js" nomodule=""></script><script src="/component---src-templates-blog-template-js-2c036092b92d9d670eba.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-27606a25c4ba33841913.js" async=""></script><script src="/framework-8e528b732ab2eaadb7b7.js" async=""></script><script src="/webpack-runtime-639daae00ea834df6c5d.js" async=""></script></body></html>